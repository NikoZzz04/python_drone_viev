<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cesium Drone Flight Demo</title>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body, #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #toggleCameraBtn {
            position: absolute;
            right: 20px;
            top: 20px;
            z-index: 9999;
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 10px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-family: sans-serif;
            user-select: none;
        }
        #toggleCameraBtn:hover {
            background: rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>

<div id="cesiumContainer"></div>
<div id="toggleCameraBtn">Toggle Camera</div>

<script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>

<script>
window.onload = function () {

    Cesium.Ion.defaultAccessToken = "CESIUM_ION_TOKEN";

    // Viewer
    const viewer = new Cesium.Viewer("cesiumContainer", {
        terrain: Cesium.Terrain.fromWorldTerrain(),
        timeline: false,
        animation: false,
        baseLayerPicker: false,
        geocoder: false,
        homeButton: false,
        navigationHelpButton: true,
        fullscreenButton: false
    });

    // Punkty trasy drona
    const punktyTrasy = [
        { lon: 21.181285, lat: 51.407653, h: 120 },
        { lon: 21.0122,  lat: 52.2297,  h: 400 },
        { lon: 19.9449,  lat: 50.0647,  h: 700 },
        { lon: 17.0385,  lat: 51.1079,  h: 900 },
        { lon: 18.6466,  lat: 54.3520,  h: 600 },
        { lon: 21.181285, lat: 51.407653, h: 250 }
    ];

    // Czas
    const totalSeconds = 1800;
    const start = Cesium.JulianDate.now();
    const stop  = Cesium.JulianDate.addSeconds(start, totalSeconds, new Cesium.JulianDate());

    viewer.clock.startTime = start.clone();
    viewer.clock.stopTime  = stop.clone();
    viewer.clock.currentTime = start.clone();
    viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP;
    viewer.clock.multiplier = 1;
    viewer.clock.shouldAnimate = true;

    // Trajektoria
    const property = new Cesium.SampledPositionProperty();
    punktyTrasy.forEach((p, i) => {
        const time = Cesium.JulianDate.addSeconds(
            start,
            (i / (punktyTrasy.length - 1)) * totalSeconds,
            new Cesium.JulianDate()
        );
        const pos = Cesium.Cartesian3.fromDegrees(p.lon, p.lat, p.h);
        property.addSample(time, pos);
    });
    property.setInterpolationOptions({
        interpolationDegree: 2,
        interpolationAlgorithm: Cesium.HermitePolynomialApproximation
    });

    // Dron
    /*const dron = viewer.entities.add({
        availability: new Cesium.TimeIntervalCollection([ new Cesium.TimeInterval({ start, stop }) ]),
        position: property,
        orientation: new Cesium.VelocityOrientationProperty(property),
        /*model: {
            uri: "https://raw.githubusercontent.com/CesiumGS/cesium/main/Apps/SampleData/models/CesiumDrone/CesiumDrone.glb",
            minimumPixelSize: 80,
            maximumScale: 200,
            show: false
        },*/
        /*path: {
            width: 4,
            leadTime: 0,
            trailTime: totalSeconds,
            material: Cesium.Color.YELLOW,
            show: false
        }
    });*/
    let shouldLockCamera = true;

    // Ustaw przycisk zawsze po lewej stronie toolbara Cesium
    function positionToggleButton() {
        const toolbar = document.querySelector(".cesium-viewer-toolbar");
        const btn = document.getElementById("toggleCameraBtn");

        if (!toolbar || !btn) return;

        const toolbarRect = toolbar.getBoundingClientRect();

        // Pozycja przycisku:
        // "po lewej" = Move button so its RIGHT edge touches toolbar's LEFT edge
        btn.style.top = toolbarRect.top + "px";
        btn.style.right = (window.innerWidth - toolbarRect.left + 10) + "px";
    }

    // Po załadowaniu wszystkiego ustaw pozycję
    setTimeout(positionToggleButton, 200);

    // Reaguj na resize okna — Cesium zmienia layout
    window.addEventListener("resize", positionToggleButton);


   // CAMERA OFFSET — follow camera
    const cameraOffset = new Cesium.HeadingPitchRange(
        0,                            // heading
        Cesium.Math.toRadians(-30),   // pitch
        2000                          // range (oddalenie)
    );

    // CINEMATIC FOLLOW CAMERA
    viewer.scene.preRender.addEventListener(function () {
        const time = viewer.clock.currentTime;
        const pos = dron.position.getValue(time);

        if (pos) {
            viewer.camera.lookAt(pos, cameraOffset);
        }
    });
    
    viewer.trackedEntity = dron;
}
</script>
</body>
</html>
